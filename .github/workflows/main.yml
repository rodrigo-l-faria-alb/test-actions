name: Delete Package v2

on:
  push:
    branches:    
      - 'main'

jobs:
  delete-packages:
    runs-on: ubuntu-latest
    steps:
      - name: Delete Package Versions
        run: |
          echo 'Starting retrieving versions of package'
          #curl -s -H "Accept:application/vnd.github.v3+json" -H "Authorization:token ${{ secrets.MY_GITHUB_PAT }}" https://api.github.com/users/rodrigolfaria/packages/container/test-actions/versions -o /tmp/response.json
          curl -s -H "Accept:application/vnd.github.v3+json" -H "Authorization:token ${{ secrets.TESTING_SECRET }}" https://api.github.com/orgs/AlticeLabsProjects/packages/container/chomesm%2Fchomesm-engine/versions -o /tmp/response.json
          echo 'inicio'
          #echo `cat /tmp/response.json`
          echo 'fim'
          packagesId=`cat /tmp/response.json | jq '.[] | .id'`

          for packageId in $packagesId; do
            echo "TEST:: ${packageId}"
            #packageDetailUrl=https://api.github.com/users/rodrigolfaria/packages/container/test-actions/versions/$packageId
            packageDetailUrl=https://api.github.com/orgs/AlticeLabsProjects/packages/container/chomesm%2Fchomesm-engine/versions/$packageId
            curl -s -H "Accept: application/vnd.github.v3+json" -H "Authorization: token ${{ secrets.TESTING_SECRET }}" $packageDetailUrl -o /tmp/response.json
            tagName=`cat /tmp/response.json | jq '.metadata.container.tags' | jq '.[]'`
            echo "TEST 2:: ${tagName}"
            if [[ ! $tagName =~ [0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}-r[0-9]{12} ]]
              then
                echo "ENTREI NO IF"
                echo "Deleting item with id: ${packageId} and tag name: ${tagName}"
                urlToDelete=https://api.github.com/orgs/AlticeLabsProjects/packages/container/chomesm%2Fchomesm-engine/versions/$packageId
                curl -s -X DELETE -H "Accept:application/vnd.github.v3+json" -H "Authorization:token ${{ secrets.TESTING_SECRET }}" $urlToDelete
            fi
          done
          echo 'Finish execution'
        shell: bash
